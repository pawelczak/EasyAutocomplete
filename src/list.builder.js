/*
 * EasyAutocomplete - ListBuilderService 
 *
 * @author Łukasz Pawełczak 
 *
 */
var EasyAutocomplete = (function (scope) {

	scope.ListBuilderService = function ListBuilderService(configuration, proccessResponseData) {


		this.init = function (data) {
			var listBuilder = [],
				builder = {};

			builder.data = configuration.get('listLocation')(data);
			builder.getValue = configuration.get('getValue');
			builder.maxListSize = configuration.get('list').maxNumberOfElements;


			listBuilder.push(builder);

			return listBuilder;
		};

		this.updateCategories = function (listBuilder, data) {

			if (configuration.get('categoriesAssigned')) {

				listBuilder = [];

				for (var i = 0; i < configuration.get("categories").length; i += 1) {

					var builder = convertToListBuilder(configuration.get('categories')[i], data);

					listBuilder.push(builder);
				}

			}

			return listBuilder;
		};

		this.convertXml = function (listBuilder) {
			if (configuration.get('dataType').toUpperCase() === 'XML') {

				for (var i = 0; i < listBuilder.length; i += 1) {
					listBuilder[i].data = convertXmlToList(listBuilder[i]);
				}
			}

			return listBuilder;
		};

		this.processData = function (listBuilder, inputPhrase) {

			for (var i = 0, length = listBuilder.length; i < length; i += 1) {
				listBuilder[i].data = proccessResponseData(configuration, listBuilder[i], inputPhrase);
			}

			return listBuilder;
		};

		this.checkIfDataExists = function (listBuilders) {

			for (var i = 0, length = listBuilders.length; i < length; i += 1) {

				if (listBuilders[i].data !== undefined && listBuilders[i].data instanceof Array) {
					if (listBuilders[i].data.length > 0) {
						return true;
					}
				}
			}

			return false;
		};


		function convertToListBuilder(category, data) {

			var builder = {};

			if (configuration.get('dataType').toUpperCase() === 'XML') {

				builder = convertXmlToListBuilder();
			} else {

				builder = convertDataToListBuilder();
			}


			if (category.header !== undefined) {
				builder.header = category.header;
			}

			if (category.maxNumberOfElements !== undefined) {
				builder.maxNumberOfElements = category.maxNumberOfElements;
			}

			if (configuration.get('list').maxNumberOfElements !== undefined) {

				builder.maxListSize = configuration.get('list').maxNumberOfElements;
			}

			if (category.getValue !== undefined) {

				if (typeof category.getValue === 'string') {
					var defaultsGetValue = category.getValue;
					builder.getValue = function (element) {
						return element[defaultsGetValue];
					};
				} else if (typeof category.getValue === 'function') {
					builder.getValue = category.getValue;
				}

			} else {
				builder.getValue = configuration.get('getValue');
			}


			return builder;


			function convertXmlToListBuilder() {

				var builder = {},
					listLocation;

				if (category.xmlElementName !== undefined) {
					builder.xmlElementName = category.xmlElementName;
				}

				if (category.listLocation !== undefined) {

					listLocation = category.listLocation;
				} else if (configuration.get('listLocation') !== undefined) {

					listLocation = configuration.get('listLocation');
				}

				if (listLocation !== undefined) {
					if (typeof listLocation === 'string') {
						builder.data = $(data).find(listLocation);
					} else if (typeof listLocation === 'function') {

						builder.data = listLocation(data);
					}
				} else {

					builder.data = data;
				}

				return builder;
			}


			function convertDataToListBuilder() {

				var builder = {};

				if (category.listLocation !== undefined) {

					if (typeof category.listLocation === 'string') {
						builder.data = data[category.listLocation];
					} else if (typeof category.listLocation === 'function') {
						builder.data = category.listLocation(data);
					}
				} else {
					builder.data = data;
				}

				return builder;
			}
		}

		function convertXmlToList(builder) {
			var simpleList = [];

			if (builder.xmlElementName === undefined) {
				builder.xmlElementName = configuration.get('xmlElementName');
			}


			$(builder.data).find(builder.xmlElementName).each(function () {
				simpleList.push(this);
			});

			return simpleList;
		}

	};

	return scope;

})(EasyAutocomplete || {});

